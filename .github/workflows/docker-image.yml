name: Docker Image CI

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      env: 
        MYSQL_ROOT_PASSWORD= ${{ root }}
        MYSQL_DATABASE= ${{ example_db }}
        MYSQL_TEST_DATABASE= ${{test_db}}
        MYSQL_LOCAL_PORT= ${{3307}}
        MYSQL_DOCKER_PORT= ${{3307}}
        MYSQL_USERNAME= ${{root}}
        MYSQL_HOST= ${{mysqldb}}

        MYSQL_HOST= ${{mysqldb}}
        NODEJS_LOCAL_PORT= ${{3001}}
        NODEJS_DOCKER_PORT= ${{3001}}
        FRONTEND_CLIENT_ORIGIN= ${{http://localhost:3000}}

        JWT_SECRET= ${{soy_el_secreto}}
      run: docker-compose build
    - name: Crear base de datos test
      run: docker-compose -f docker-compose.test.yaml run app yarn sequelize db:create
    - name: Correr migraciones en base de datos test
      run: docker-compose -f docker-compose.test.yaml run app yarn sequelize db:migrate
    - name:  Correr tests
      run: docker-compose -f docker-compose.test.yaml run app npm test
